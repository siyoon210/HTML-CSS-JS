<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
</head>
<body>
<input id="files" type="file" accept="application/json" multiple/>

<button id="btn">변환2</button>
<br>
<textarea id="result" style="width:100%; height:800px"></textarea>
</body>
<script>
    let unionFileString;

    function readFile(file) {
        return new Promise((resolve, reject) => {
            let fr = new FileReader();
            fr.error = reject;
            fr.onload = () => {
                // 각 [ , ] 는 subString으로 제거
                resolve(unionFileString += fr.result.substring(1, fr.result.length - 1));
            };
            fr.readAsText(file, "utf-8");
        })
    }

    const files = document.getElementById('files');
    files.addEventListener('change', async (e) => {
        // 날짜순으로 정렬
        let files = Array.from(e.target.files).sort((a, b) => {
            if (a.name < b.name) {
                return -1;
            }
            if (a.name > b.name) {
                return 1;
            }

            return 0;
        });

        unionFileString = '[';
        for (const [i, file] of files.entries()) {
            await readFile(file);

            if (i !== files.length - 1) {
                unionFileString += ',';
            }
        }
        unionFileString += ']';
    });

    String.prototype.adjustCodeBlock = function () {
        return this.replace(/```/g, '\n```\n');
    };

    String.prototype.title = function () {
        return this.replace(/\n/g, '\n### ');
    };

    String.prototype.reply = function () {
        return this.replace(/\n/g, '\n> ');
    };

    $('#btn').on('click', function () {
        const jsonObj = JSON.parse(unionFileString);

        let chatMap = new Map();

        function isThreadReply(chat) {
            return chat['thread_ts'] !== undefined && chat['thread_ts'] !== chat['ts'];
        }

        // 리플이면 기존 글에다가 붙여주기
        for (let i = 0; i < jsonObj.length; i++) {
            // subtype이 존재하면 일반 메시지가 아님. (ex 조인메세지, 채널 정보수정)
            if (jsonObj[i]['subtype'] !== undefined) {
                continue;
            }

            // 유저네임이 없는 경우
            if (jsonObj[i]['user_profile'] === undefined) {
                console.error('REAL NAME NOT FOUND ', jsonObj[i]['ts']);
                continue;
            }
            if (isThreadReply(jsonObj[i])) {
                let origin = chatMap.get(jsonObj[i]['thread_ts']);
                if (origin === undefined) {
                    console.error('UNDEFINED ORIGIN CHAT', jsonObj[i]['text']);
                    continue;
                }
                origin.reply.push(jsonObj[i]);
            } else {
                jsonObj[i].reply = [];
                chatMap.set(jsonObj[i]['ts'], jsonObj[i]);
            }
        }

        let text = [];

        // md 파일로 텍스트 쓰기
        chatMap.forEach(function (value) {
            if (!isThreadReply(value)) {
                text += '__**' + value['user_profile']['real_name'] + '**__\n ' + value['text'].adjustCodeBlock() + '\n\n';
                value.reply.forEach(value1 => {
                    text += '>__**' + value1['user_profile']['real_name'] + '**__\t' + value1['text'].adjustCodeBlock().reply() + '\n\n';
                });
                text += '---\n';
            }
        });

        $('#result').text(text);
    });
</script>
</html>