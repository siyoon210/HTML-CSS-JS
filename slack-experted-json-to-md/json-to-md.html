<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<input id="users" type="file" accept="application/json"/>
<br>
<input id="chatLog" type="file" accept="application/json" multiple/>
<br>

<button id="convert-btn">변환</button>
<br>
<textarea id="mdText" style="width:100%; height:800px"></textarea>
</body>
<script>
    window.addEventListener("load", eventBinding);

    function eventBinding() {
        document.getElementById('convert-btn').addEventListener('click', convertJsonToMd);
    }

    //todo [http://bit.ly/2NZ1l7u|Asserts] 링크이상
    //todo users.json이랑 파일들 존재하는지 확인, 이름 확인

    function readFile(file) {
        return new Promise((resolve, reject) => {
            let fr = new FileReader();
            fr.error = reject;
            fr.onload = () => {
                resolve(fr.result);
            };
            fr.readAsText(file, "utf-8");
        })
    }

    // 리플에 들여쓰기
    String.prototype.indent = function () {
        return this.replace(/\n/g, '\n    ');
    };

    // \n이 한개뿐이면 개행이 되지 않아 하나 더 추가한다.
    String.prototype.addOneMoreLineBreak = function () {
        return this.replace(/\n/g, '\n\n');
    };

    String.prototype.adjustCodeBlock = function () {
        return this.replace(/```/g, '\n```\n')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"');
    };

    async function convertJsonToMd() {
        const users = await _getUsers();

        const chatLogJson = JSON.parse(await _getChatLogJson());

        let chatMap = new Map();

        // 리플인지 아닌지 확인하고, 리플이면 본문에 넣어줌
        for (let i = 0; i < chatLogJson.length; i++) {
            if (_isThreadReply(chatLogJson[i])) {
                let origin = chatMap.get(chatLogJson[i]['thread_ts']);
                if (origin === undefined) {
                    console.error('UNDEFINED ORIGIN CHAT', chatLogJson[i]['text']);
                    continue;
                }
                origin.reply.push(chatLogJson[i]);
            } else {
                chatLogJson[i].reply = [];
                chatMap.set(chatLogJson[i]['ts'], chatLogJson[i]);
            }
        }

        let text = [];

        // md 파일로 텍스트 쓰기
        chatMap.forEach(function (value) {
            if (!_isThreadReply(value)) {
                text += `${getUserName(value)} ${getDate(value)}\n\n${getContent(value)}\n\n`;

                //리플 붙이기
                value.reply.forEach(replyValue => {
                    text += `- ${getUserName(replyValue)} ${getDate(replyValue)}\n\n${getContent(replyValue)}\n\n`;
                });
                text += '\n---\n';
            }
        });

        document.getElementById("mdText").setRangeText(text);

        /**
         * users.json으로부터 user 정보를 배열로 받아온다.
         * 배열은 'id'값을 key로 사용한다. ex) users['UV32QS4Q3']
         * @returns {Promise<*>}
         */
        async function _getUsers() {
            let usersJson = await readFile(document.getElementById('users').files[0]);
            let userObj = JSON.parse(usersJson);

            return userObj.reduce(function (map, obj) {
                map[obj.id] = obj;
                return map;
            }, {});
        }

        async function _getChatLogJson() {
            let chatLog = document.getElementById('chatLog');

            // 날짜순으로 정렬
            chatLog = Array.from(chatLog.files).sort((a, b) => {
                if (a.name < b.name) {
                    return -1;
                }
                if (a.name > b.name) {
                    return 1;
                }

                return 0;
            });


            //json 파일 하나로 통합
            let chatLogJson;
            chatLogJson = '[';
            for (const [i, file] of chatLog.entries()) {
                let textFile = await readFile(file);
                // 각 파일들의 대괄호 [ , ] 는 제거
                chatLogJson += textFile.substring(1, textFile.length - 1);
                if (i !== chatLog.length - 1) {
                    chatLogJson += ',';
                }
            }
            chatLogJson += ']';

            return chatLogJson;
        }

        function _isThreadReply(chat) {
            return chat['thread_ts'] !== undefined && chat['thread_ts'] !== chat['ts'];
        }

        function getUserName(value) {
            const realName = users[value['user']]['profile']['real_name'];
            const thumbNailImg = users[value['user']]['profile']['image_48'];

            return `<img src="${thumbNailImg}" width="30px"> **${realName}**`;
        }

        function getDate(value) {
            return `(${new Date(value['ts'] * 1000).toLocaleString()})`;
        }

        function getContent(value) {
            if (value['text']) {
                if (_isThreadReply(value)) {
                    return `    ${value['text'].addOneMoreLineBreak().adjustCodeBlock().indent()}`;
                }
                return `${value['text'].addOneMoreLineBreak().adjustCodeBlock()}`;
            }

            if (value['files']) {
                return value['files']
                    .map(file => `![${file['name']}](${file['url_private']})`)
                    .join('\n');
            }

            console.error('No Content');
            return ""
        }
    }
</script>
</html>