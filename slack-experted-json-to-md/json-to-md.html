<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
</head>
<body>

<input id="usersFile" type="file" accept="application/json"/>
<br>
<input id="files" type="file" accept="application/json" multiple/>
<br>

<button id="btn">변환2</button>
<br>
<textarea id="result" style="width:100%; height:800px"></textarea>
</body>
<script>
    //todo users.json이랑 파일들 존재하는지 확인, 이름 확인
    let unionFileString;

    function readFile(file) {
        return new Promise((resolve, reject) => {
            let fr = new FileReader();
            fr.error = reject;
            fr.onload = () => {
                resolve(fr.result);
            };
            fr.readAsText(file, "utf-8");
        })
    }

    const files = document.getElementById('files');
    files.addEventListener('change', async (e) => {
        // 날짜순으로 정렬
        let files = Array.from(e.target.files).sort((a, b) => {
            if (a.name < b.name) {
                return -1;
            }
            if (a.name > b.name) {
                return 1;
            }

            return 0;
        });

        unionFileString = '[';
        for (const [i, file] of files.entries()) {
            let textFile = await readFile(file);
            // 각 [ , ] 는 subString으로 제거
            unionFileString += textFile.substring(1, textFile.length - 1);
            if (i !== files.length - 1) {
                unionFileString += ',';
            }
        }
        unionFileString += ']';
    });

    String.prototype.adjustCodeBlock = function () {
        return this.replace(/```/g, '\n```\n');
    };

    String.prototype.title = function () {
        return this.replace(/\n/g, '\n### ');
    };

    String.prototype.reply = function () {
        return this.replace(/\n/g, '\n> ');
    };

    $('#btn').on('click', async function () {
        async function getUsersMap() {
            let usersFile = document.getElementById('usersFile');
            let usersJson = await readFile(usersFile.files[0]);
            let userObj = JSON.parse(usersJson);

            return  userObj.reduce(function (map, obj) {
                map[obj.id] = obj;
                return map;
            }, {});
        }

        const usersMap = await getUsersMap();

        const jsonObj = JSON.parse(unionFileString);

        let chatMap = new Map();

        function isThreadReply(chat) {
            return chat['thread_ts'] !== undefined && chat['thread_ts'] !== chat['ts'];
        }

        // 리플인지 아닌지 확인하고, 리플이면 본문에 넣어줌
        for (let i = 0; i < jsonObj.length; i++) {
            if (isThreadReply(jsonObj[i])) {
                let origin = chatMap.get(jsonObj[i]['thread_ts']);
                if (origin === undefined) {
                    console.error('UNDEFINED ORIGIN CHAT', jsonObj[i]['text']);
                    continue;
                }
                origin.reply.push(jsonObj[i]);
            } else {
                jsonObj[i].reply = [];
                chatMap.set(jsonObj[i]['ts'], jsonObj[i]);
            }
        }

        let text = [];

        // md 파일로 텍스트 쓰기
        chatMap.forEach(function (value) {
            if (!isThreadReply(value)) {
                text += `${getUserName(value)} ${getDate(value)}\n${getContent(value)}\n`;

                //리플 붙이기
                value.reply.forEach(replyValue => {
                    text += `- ${getUserName(replyValue)} ${getDate(value)}\n${getContent(replyValue)}\n\n`;
                });
                text += '\n---\n';
            }
        });

        function getUserName(value) {
            const realName = usersMap[value['user']]['profile']['real_name'];
            const thumbNailImg = usersMap[value['user']]['profile']['image_48'];

            return `<img src="${thumbNailImg}" width="30px"> **${realName}**`;
        }

        function getDate(value) {
            return `(${new Date(value['ts'] * 1000).toLocaleString()})`;
        }

        function getContent(value) {
            if (value['text']) {
                return `${value['text'].adjustCodeBlock()}`;
            }

            if (value['files']) {
                return value['files']
                    .map(file => `![${file['name']}](${file['url_private']})`)
                    .join('\n');
            }

            console.error('No Content');
            return ""
        }

        $('#result').text(text);
    });
</script>
</html>